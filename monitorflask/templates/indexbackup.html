<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Monitoring</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        #homeButton { position: fixed; top: 12px; right: 20px; z-index: 1031; background: white; border: 2px solid #ccc; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; }
        #homeButton:hover { transform: scale(1.1); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
        #homeButton i { font-size: 20px; color: #333; }
        body { margin: 0; font-family: sans-serif; background: #f9f9f9; }
        .layout { display: flex; flex-direction: row; height: calc(100vh - 60px); }
        .sidebar { width: 300px; padding: 20px; background: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
        .section { margin-bottom: 30px; }
        .section h2, .section h3 { display: flex; align-items: center; margin-top: 0; margin-bottom: 15px; color: #222; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .sidebar label { font-weight: 500; }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; padding-bottom: 100px; }
        canvas, #waterfallPlot { width: 100% !important; max-height: 600px; background: #fff; border-radius: 10px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); margin-bottom: 40px; }
        h2 { margin-top: 0; color: #333; }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        .brand-logo { height: 30px; margin-right: 10px; }
        .recording-indicator { height: 10px; width: 10px; background-color: #dc3545; border-radius: 50%; display: inline-block; vertical-align: middle; margin-left: 10px; animation: blink-animation 1s steps(5, start) infinite; }
        @keyframes blink-animation { to { visibility: hidden; } }
    </style>
</head>
<body>
<nav class="main-header navbar navbar-expand navbar-white navbar-light" style="box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-left:3px">
    <ul class="navbar-nav">
        <li class="nav-item d-flex align-items-center">
            <img src="{{ url_for('static', filename='img/polsri.png') }}" class="brand-logo" alt="Polsri">
            <img src="{{ url_for('static', filename='img/kominfo.png') }}" class="brand-logo" alt="Kominfo">
            <span class="font-weight-bold">SISTEM MONITORING SPEKTRUM FREKUENSI RADIO</span>
        </li>
    </ul>
    <ul class="navbar-nav ml-auto">
        <li class="nav-item">
            <a id="homeButton" href="http://127.0.0.1:5000/">
                <i class="fas fa-home"></i>
            </a>
        </li>
    </ul>
</nav>
<div class="layout">
    <div class="sidebar">
        <div class="section">
            <h2>Parameter Occupancy</h2>
            <form id="configForm">
                <label>Rentang Frekuensi (MHz):</label>
                <select name="frequency" required>
                    <option value="87:108" selected>1. Radio FM, DRM (87-108)</option>
                    <option value="108:137">2. Penerbangan VHF (108-137)</option>
                    <option value="137:174">3. Komrad VHF, Instansi (137-174)</option>
                    </select>
                <label>Bandwidth (Hz):</label>
                <select name="bandwidth">
                    <option value="50000" selected>50 kHz</option>
                    <option value="6250">6.25 kHz</option>
                    </select>
                <button type="submit">Terapkan</button>
            </form>
            <button id="toggleButton">Pause Monitoring</button>
        </div>
        <hr>
        <div class="section">
            <h3>
                Monitoring & Simpan Otomatis
                <span id="recording-indicator" class="recording-indicator" style="display: none;"></span>
            </h3>
            <form id="timedMonitoringForm">
                <label>Durasi Monitoring:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="monitoringDuration" value="1" min="1" required style="width: 60%;">
                    <select id="monitoringUnit" style="width: 40%;">
                        <option value="minutes">Menit</option>
                        <option value="hours">Jam</option>
                    </select>
                </div>
                <button type="submit" id="startTimedMonitoringBtn">Mulai Rekam</button>
                <p id="timedStatus" style="text-align: center; font-weight: bold; margin-top: 10px; color: #28a745; min-height: 1.2em;"></p>
            </form>
        </div>
        <hr>
        <div class="section">
            <h3>Panggil Data Tersimpan</h3>
            <form id="recallForm">
                <label>Pilih File Log:</label>
                <select id="logFileSelect" name="log_file" required>
                    <option value="" disabled selected>-- Muat daftar file --</option>
                </select>
                <button type="button" id="refreshLogListBtn" style="margin-bottom: 10px; background-color: #6c757d;">
                    <i class="fas fa-sync-alt"></i> Refresh Daftar
                </button>
                <button type="submit">Tampilkan Grafik</button>
            </form>
        </div>
    </div>
    <div class="content">
        <h2>Grafik PSD</h2>
        <canvas id="psdChart"></canvas>
        <h2>Waterfall</h2>
        <div id="waterfallPlot"></div>
    </div>
</div>

<script>
    // === DEKLARASI ELEMEN & VARIABEL GLOBAL ===
    const psdCtx = document.getElementById("psdChart").getContext("2d");
    const toggleBtn = document.getElementById("toggleButton");
    const configForm = document.getElementById('configForm');
    const timedForm = document.getElementById('timedMonitoringForm');
    const recallForm = document.getElementById('recallForm');
    const recordingIndicator = document.getElementById('recording-indicator');
    const timedStatus = document.getElementById('timedStatus');
    const startTimedBtn = document.getElementById('startTimedMonitoringBtn');
    const logFileSelect = document.getElementById('logFileSelect');
    const refreshLogListBtn = document.getElementById('refreshLogListBtn');

    let liveUpdateInterval = null;
    let statusCheckInterval = null;
    let isLiveMonitoring = false;
    let heatmapData = [];
    let wasRecording = false; // Flag baru untuk mendeteksi akhir rekaman

    // === SETUP GRAFIK ===
    const psdChart = new Chart(psdCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'PSD (dB)', data: [], borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.1)', fill: true, tension: 0.1, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, scales: { x: { title: { display: true, text: 'Frekuensi (MHz)' }, ticks: { maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 15 } }, y: { title: { display: true, text: 'Power (dB)' } } } }
    });

    // === FUNGSI-FUNGSI UTAMA ===

    async function updateLiveCharts() {
        if (!isLiveMonitoring) return;
        try {
            const res = await fetch('/data');
            if (!res.ok) return;
            const json = await res.json();
            const freqInput = document.querySelector('select[name="frequency"]').value;
            const [minMHz, maxMHz] = freqInput.split(':').map(Number);
            const psd = json.psd.filter(row => row.frequency >= (minMHz * 1e6) && row.frequency <= (maxMHz * 1e6));
            
            const freqs = psd.map(p => (p.frequency / 1e6).toFixed(3));
            const powers = psd.map(p => p.power);
            const timeLabel = new Date().toLocaleTimeString('id-ID');
            
            psdChart.data.labels = freqs;
            psdChart.data.datasets[0].data = powers;
            psdChart.update();
            
            heatmapData.push({ time: timeLabel, powers: powers });
            if (heatmapData.length > 20) heatmapData.shift();
            Plotly.newPlot('waterfallPlot', [{ z: heatmapData.map(h => h.powers), x: freqs, y: heatmapData.map(h => h.time), type: 'heatmap', colorscale: 'Jet' }], { title: 'Waterfall Spektrum', xaxis: { title: 'Frekuensi (MHz)' }, yaxis: { title: 'Waktu' } }, { responsive: true });
        } catch (error) {
            console.error("Gagal memperbarui grafik live:", error);
            stopLiveMonitoring(); // Hentikan jika ada error agar tidak loop terus
        }
    }

    function startLiveMonitoring() {
        if (isLiveMonitoring) return;
        isLiveMonitoring = true;
        toggleBtn.textContent = '⏸️ Pause Monitoring';
        toggleBtn.classList.remove('btn-success');
        updateLiveCharts();
        liveUpdateInterval = setInterval(updateLiveCharts, 3000);
    }

    function stopLiveMonitoring() {
        if (!isLiveMonitoring) return;
        isLiveMonitoring = false;
        clearInterval(liveUpdateInterval);
        toggleBtn.textContent = '▶️ Resume Monitoring';
        toggleBtn.classList.add('btn-success');
    }

    async function checkSystemStatus() {
        try {
            const response = await fetch('/status?cache_bust=' + new Date().getTime());
            const data = await response.json();
            
            const isRecording = data.status === 'recording';
            
            recordingIndicator.style.display = isRecording ? 'inline-block' : 'none';
            startTimedBtn.disabled = isRecording;

            if (isRecording) {
                timedStatus.textContent = "Sedang Merekam...";
                wasRecording = true; // Set flag bahwa proses rekam sedang aktif
            } else if (wasRecording) {
                // Ini dieksekusi sekali saja setelah rekaman selesai
                timedStatus.textContent = "Perekaman Selesai.";
                loadLogFiles(); // Otomatis refresh daftar file
                wasRecording = false; // Reset flag
                setTimeout(() => { timedStatus.textContent = ""; }, 4000); // Hapus pesan setelah 4 detik
            }
        } catch (error) {
            console.error("Gagal memeriksa status sistem:", error);
        }
    }

    async function loadLogFiles() {
        try {
            logFileSelect.innerHTML = '<option value="">Memuat...</option>';
            const response = await fetch('/list-logs?cache_bust=' + new Date().getTime());
            const files = await response.json();
            logFileSelect.innerHTML = '';
            if (files.length === 0) {
                logFileSelect.innerHTML = '<option value="" disabled selected>Tidak ada file log</option>';
            } else {
                logFileSelect.innerHTML = '<option value="" disabled selected>Pilih file</option>';
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.textContent = file;
                    logFileSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Gagal memuat daftar file log:", error);
            logFileSelect.innerHTML = '<option value="" disabled selected>Error memuat daftar</option>';
        }
    }

    // === EVENT LISTENERS ===

    toggleBtn.addEventListener('click', () => { isLiveMonitoring ? stopLiveMonitoring() : startLiveMonitoring(); });

    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = e.target.querySelector('button[type="submit"]');
        button.textContent = 'Menerapkan...';
        button.disabled = true;
        try {
            await fetch('/config', { method: 'POST', body: new FormData(e.target) });
            heatmapData = [];
            if (isLiveMonitoring) await updateLiveCharts();
        } catch (error) {
            console.error('Error saat menerapkan konfigurasi:', error);
        } finally {
            button.textContent = 'Terapkan';
            button.disabled = false;
        }
    });

    timedForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const duration = document.getElementById('monitoringDuration').value;
        const unit = document.getElementById('monitoringUnit').value;
        const freqSelect = document.querySelector('select[name="frequency"]');
        const bandName = freqSelect.options[freqSelect.selectedIndex].text;
        
        startTimedBtn.disabled = true;
        timedStatus.textContent = "Memulai perekaman...";
        
        try {
            const response = await fetch('/start-timed-monitoring', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ duration: parseInt(duration), unit: unit, bandName: bandName }) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Gagal memulai perekaman.');
            // Biarkan `checkSystemStatus` yang mengambil alih tampilan
        } catch (error) {
            console.error('Error:', error);
            timedStatus.textContent = `Error: ${error.message}`;
            startTimedBtn.disabled = false;
        }
    });

    refreshLogListBtn.addEventListener('click', loadLogFiles);

    recallForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const selectedFile = logFileSelect.value;
        if (!selectedFile) { alert("Silakan pilih file log."); return; }
        
        stopLiveMonitoring(); // Hentikan live view
        timedStatus.textContent = `Memuat data dari: ${selectedFile}`;
        
        try {
            const response = await fetch(`/get-log-data/${selectedFile}`);
            const data = await response.json();
            if (data.error) { throw new Error(data.error); }
            
            psdChart.data.labels = data.psd.map(p => (p.frequency / 1e6).toFixed(3));
            psdChart.data.datasets[0].data = data.psd.map(p => p.power);
            psdChart.update();
            Plotly.newPlot('waterfallPlot', []); // Kosongkan waterfall
            timedStatus.textContent = `Menampilkan: ${selectedFile}`;
        } catch (error) {
            console.error("Error mengambil data log:", error);
            alert(`Terjadi kesalahan: ${error.message}`);
            timedStatus.textContent = "";
        }
    });

    // === INISIALISASI HALAMAN ===
    document.addEventListener('DOMContentLoaded', () => {
        startLiveMonitoring();
        loadLogFiles();
        statusCheckInterval = setInterval(checkSystemStatus, 2000);
    });
</script>
</body>
</html>
